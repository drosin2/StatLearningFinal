---
title: "Stats Learning Final Project"
author: "Jack Rudnick, Luke Lorenz, Doug Rosin"
date: "4/10/2022"
output: html_document
---

#TO DO:  
-     
- Impute NA values (need to change categorical cols classified as numeric to factor)
- create random forests for all vars, then quantitative only (idealized/initial assesment)
- Compare our prediction of mortality against SOFA pred of mortality (% acc or sd error?)



```{r}
library(tidyverse)
library(randomForest)
library(iml)
```


```{r}
data <- read.csv("full_cohort_data.csv")
```

```{r convert to factors}
data <- data %>%
  mutate(gender_num = factor(gender_num,
                             levels = c(0,1),
                             labels = c("Female", "Male")),
         aline_flg = factor(aline_flg,
                             levels = c(0,1),
                             labels = c("Year", "No")),
         service_num = factor(service_num,
                              levels = c(0,1),
                              labels = c("MICU or FICU", "SICU")),
         icu_exp_flg = factor(icu_exp_flg,
                               levels = c(0,1),
                               labels = c("No","Yes")),
         hosp_exp_flg = factor(hosp_exp_flg,
                               levels = c(0,1),
                               labels = c("No","Yes")),
         day_28_flg = factor(day_28_flg,
                               levels = c(0,1),
                               labels = c("No","Yes")),
         censor_flg = factor(censor_flg,
                               levels = c(0,1),
                               labels = c("Death","Censored")),
         sepsis_flg = factor(sepsis_flg,
                               levels = c(0,1),
                               labels = c("No","Yes")),
         chf_flg = factor(chf_flg,
                               levels = c(0,1),
                               labels = c("No","Yes")),
         afib_flg = factor(afib_flg,
                               levels = c(0,1),
                               labels = c("No","Yes")),
         renal_flg = factor(renal_flg,
                               levels = c(0,1),
                               labels = c("No","Yes")),
         liver_flg = factor(liver_flg,
                               levels = c(0,1),
                               labels = c("No","Yes")),
         copd_flg = factor(copd_flg,
                               levels = c(0,1),
                               labels = c("No","Yes")),
         cad_flg = factor(cad_flg,
                               levels = c(0,1),
                               labels = c("No","Yes")),
         stroke_flg = factor(stroke_flg,
                               levels = c(0,1),
                               labels = c("No","Yes")),
         mal_flg = factor(mal_flg,
                               levels = c(0,1),
                               labels = c("No","Yes")),
         resp_flg = factor(resp_flg,
                               levels = c(0,1),
                               labels = c("No","Yes"))
         )

```


```{r imputing NA values}
na_indicies <- which(is.na(data), arr.ind=TRUE)  


# Function to calculate the mode
Mode <- function(x) {
  xx <- unique(x)
  xx[which.max(tabulate(match(x, xx)))]
}


#replace the factor variables with the mode
for(i in 1:ncol(data)){
  for(j in 1:nrow(data)){
    if(class(data[[i]])== "numeric"){
      if (is.na(data[j,i])){
        data[j,i] <- median(as.numeric(unlist(data[,i])),
                            na.rm= TRUE)
      }
    }
    else{
      if (is.na(data[j,i])){
        data[j,i]<-Mode(na.omit(data[,i]))
    }
  }
  }
}

```


```{r}
iterate <- function(proxMatrix){
  for (i in 1:nrow(na_indicies)){
  column_names <-colnames(data)
  # Storing indicies of the na value
  rowNum <- na_indicies[i,1]
  colNum <- na_indicies[i,-1]
  column_name <- column_names[colNum]
  # If the column contains numeric variables as opposed to categorical

  if(sapply(data[,colNum], class)[1] == "numeric"){
    # print("Entering col 5")
    #updtating NA val with imputed val across the column
    imputed_val <- sum(data[-rowNum,column_name] * proxMatrix[-rowNum,rowNum]/ sum(proxMatrix[-rowNum,rowNum]))
    data[rowNum,colNum] <- imputed_val
    
  }else{ #Contains categorical vars, not numeric
    # print("entering other col")
    #df to store proximity excluding the row of intrest
    df_factor <- data.frame(proximity = proxMatrix[-rowNum,rowNum],
                            class = data[-rowNum,column_name])
    
    val <- df_factor %>% #computing for mode
      group_by_at("class") %>%
      summarize(avg = mean(proximity))
    index <- which.max(val$avg)
    data[rowNum,column_name] <- val[index,1]
  }
}
  
  
}
```

```{r imputing na data}
for (i in 1:20){
  #Fitting random forest to predict censor + getting prox mtx
  rf <- randomForest(formula = censor_flg ~., 
                   data = data,
                   proximity = TRUE)
  pmtx <- data.frame(rf$proximity)
  
  iterate(pmtx)
  print(paste("iteration", i , "done"))
}
```


#LINEAR REGRESSION FOR ICU STAY

For predicting the length of stay in the icu
  
```{r mean, median, mode for ICU stay}

```


```{r mean, median, and mode for the length of ICU stay}
ggplot(data = data,
       aes(x = icu_los_day))+
  geom_histogram(binwidth = 0.4) +
  labs(x = "Length of Stay in the Hospital (Days)")

```

```{r maybe facet wrap based on a variable of intrest?}
ggplot(data = data,
       aes(x = icu_los_day))+
  geom_histogram(binwidth = 0.4) +
  labs(x = "Length of Stay in the Hospital (Days)") +
  facet_grid(~service_num)
```
#Medical intensive care unit vs surgical intensive care unit



```{r boxplot for outliers}
#computing outliers
outlier_data <- data %>%
  mutate(outlier = icu_los_day > median(icu_los_day) + IQR(icu_los_day) * 1.5)

ggplot(data = outlier_data,
       aes(x = icu_los_day,
           y =  ""))+
  geom_boxplot(outlier.shape = NA) +
  #for better outlier visualization
  geom_point(data = function(x) dplyr::filter_(x, ~ outlier), position = 'jitter')
  labs(x = "Length of Stay in the Hospital (Days)")
```
#When looking at this data, we can see we have a large distribution of stays (1776) around the 2-4 day mark, but there are also 214 outliers in the data. These two are equally important to distinguish, as long stays in the ICU are resource intensive and important for allocation with finite spaces.

```{r getting the percent of outliers}
count(outlier_data %>% filter(outlier == TRUE)) / count(outlier_data %>% filter(outlier == FALSE)) *100
```
13.7 percent of our patients admitted into the ICU were outliers

#FIT LR model on non-outliers, or short stay, vs outliers, or long stay

```{r splitting into testing/training}
set.seed(1)
n <- nrow(data)
set.seed(10)
# Common to use 70% or 80% of observations for training set
train_indices <- sample(1:n, size = floor(0.8*n)) 
train_data <- data %>%
  slice(train_indices)
test_data <- data %>%
  slice(-train_indices)
```
#Do we need to filter data for outliers before or after splitting into testing/training???
#Can also filter where the duration of stay is above XXX days?

```{r}
#count unique vars
sapply(lapply(data, unique), length)
```
we can see sepsis_flg only has one var, so we do not include it in our model fitting

```{r Linear regression model for shorter stay (on training)}

#Taking a linear model without sepsis, because that column has no unique values
m <- lm(formula = icu_los_day ~ ., data = subset(data,
                                                 select = -sepsis_flg)) 
m
```

```{r making predictions}
pred_short_stay <- predict(m, newdata = test_data)
```

```{r compute MSE and RMSE}
mean( (test_data$icu_los_day - pred_short_stay)^2 ) # test MSE
sqrt( mean( (test_data$icu_los_day - pred_short_stay)^2 ) ) # test RMSE
```


```{r Linear regression model for longer stay (on training)}

```

#Then fit one more model to predict
```{r polynomial regression}

```

#Finally, comparing with knn regression
```{r running knn regression on our dataset to predict LOS in ICU}

```







#A non-linear model is likely better, so we can try polynomial regression!
```{r trying polynomial reg}

```



#FITTING RANDOM FOREST FOR CENSOR_FLG
```{r}
gort <- data %>%
  select(-mort_day_censored,-hosp_exp_flg,-icu_exp_flg,-day_28_flg)
```


```{r}
rf <- randomForest(formula =  censor_flg~ ., #for importance of heart disease
                   data = na.omit(gort),
                   importance = TRUE)
```

```{r}
varImpPlot(rf)
```

```{r}
pred_obj <- Predictor$new(rf, data = na.omit(gort))
temp <- FeatureEffect$new(pred_obj, feature = "age", method = "pdp")
plot(temp)
```





